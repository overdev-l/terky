{
  "version": 3,
  "sources": ["../utils/index.ts", "../index.ts"],
  "sourcesContent": ["const worker = `\nself.onmessage = function (e) {\n  const { url, init } = e.data\n  const request = () => {\n  return fetch(url, init)\n  }\n  request().then(async res => {\n  const result = await res.text()\n  self.postMessage(result)\n  })\n}\n`\n\nconst greenlet = () => {\n    const blob = new Blob([worker], { type: 'application/javascript' })\n    const workerUrl = URL.createObjectURL(blob)\n    const workerInstance = new Worker(workerUrl)\n    return (url: string, init: any): Promise<string> => new Promise((resolve, reject) => {\n        workerInstance.onmessage = e => {\n            resolve(e.data)\n        }\n        workerInstance.onerror = e => {\n            console.log(e, 'error')\n            reject(e)\n        }\n        workerInstance.postMessage({ url: url, init: init })\n    })\n}\n\nexport const useGreenlet = greenlet()\n", "import { useGreenlet } from './utils'\ninterface FecthInit {\n    method?: 'get' | 'post',\n    headers?: Headers,\n    body?: any,\n    mode?: any\n    credentials?: any\n    cache?: any\n    redirect?: any\n    referrer?: any\n    referrerPolicy?: any\n    integrity?: any\n}\ninterface Initial {\n    delay: number\n    url?: string\n    init?: FecthInit\n    key: string,\n    loop?: boolean\n}\ninterface Data {\n    siteHash: string | null,\n    currentHash: string | null\n}\nexport function useNotification(params: Initial) {\n  const getCurrentHash = () => {\n    const body = document.querySelector('body')\n    if (!body) return ''\n    const hash = body.getAttribute('data-hash')\n    return hash\n  }\n  const regex = new RegExp(`${params.key}\\\\s*=\\\\s*['\"]([^'\"]+)['\"]`)\n  let timer: any\n  let currentHash = getCurrentHash()\n  const loop = params.loop || false\n  const useCreateNotify = (notice: boolean, data: Data) => new CustomEvent('siteUpdate', {\n    bubbles: true,\n    detail: { data: data, status: notice }\n  })\n  const queryNewHash = useGreenlet.bind(null, params.url || `${window.origin}?t=${Date.now()}`, params.init || {\n    method: 'get'\n  })\n  const validateHash = async () => {\n    const hash = await queryNewHash()\n    const data = hash.match(regex)\n    return data ? data[1] || null : null\n  }\n  const initEvent = () => {\n    window.addEventListener('load', windowLoaded)\n    document.addEventListener('visibilitychange', handleVisibilityChange)\n  }\n\n  const handleVisibilityChange = async () => {\n    if (document.visibilityState === 'visible') {\n      const hash = await validateHash()\n      if (hash !== currentHash) {\n        dispatchEvent(true, {\n          siteHash: hash,\n          currentHash: currentHash\n        })\n      } else {\n        initTimer()\n      }\n    } else {\n      clearInterval(timer)\n    }\n  }\n  const windowLoaded = async () => {\n    const hash = await validateHash()\n    if (hash !== currentHash) {\n      dispatchEvent(true, {\n        siteHash: hash,\n        currentHash: currentHash\n      })\n    }\n  }\n  const dispatchEvent = (status: boolean, data: Data) => {\n    const notice = useCreateNotify(status, data)\n    window.dispatchEvent(notice)\n    if (!loop) {\n      currentHash = data.siteHash\n    }\n  }\n  const initTimer = () => {\n    timer = setInterval(async () => {\n      const hash = await validateHash()\n      if (hash !== currentHash) {\n        dispatchEvent(true, {\n          siteHash: hash,\n          currentHash: currentHash\n        })\n      }\n    }, params.delay)\n  }\n  if (!currentHash) return\n  initEvent()\n  initTimer()\n}\n"],
  "mappings": "AAAA,IAAMA,EAAS;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAaTC,EAAW,IAAM,CACnB,IAAMC,EAAO,IAAI,KAAK,CAACF,CAAM,EAAG,CAAE,KAAM,wBAAyB,CAAC,EAC5DG,EAAY,IAAI,gBAAgBD,CAAI,EACpCE,EAAiB,IAAI,OAAOD,CAAS,EAC3C,MAAO,CAACE,EAAaC,IAA+B,IAAI,QAAQ,CAACC,EAASC,IAAW,CACjFJ,EAAe,UAAYK,GAAK,CAC5BF,EAAQE,EAAE,IAAI,CAClB,EACAL,EAAe,QAAUK,GAAK,CAC1B,QAAQ,IAAIA,EAAG,OAAO,EACtBD,EAAOC,CAAC,CACZ,EACAL,EAAe,YAAY,CAAE,IAAKC,EAAK,KAAMC,CAAK,CAAC,CACvD,CAAC,CACL,EAEaI,EAAcT,EAAS,ECL7B,SAASU,EAAgBC,EAAiB,CAC/C,IAAMC,EAAiB,IAAM,CAC3B,IAAMC,EAAO,SAAS,cAAc,MAAM,EAC1C,OAAKA,EACQA,EAAK,aAAa,WAAW,EADxB,EAGpB,EACMC,EAAQ,IAAI,OAAO,GAAGH,EAAO,8BAA8B,EAC7DI,EACAC,EAAcJ,EAAe,EAC3BK,EAAON,EAAO,MAAQ,GACtBO,EAAkB,CAACC,EAAiBC,IAAe,IAAI,YAAY,aAAc,CACrF,QAAS,GACT,OAAQ,CAAE,KAAMA,EAAM,OAAQD,CAAO,CACvC,CAAC,EACKE,EAAeC,EAAY,KAAK,KAAMX,EAAO,KAAO,GAAG,OAAO,YAAY,KAAK,IAAI,IAAKA,EAAO,MAAQ,CAC3G,OAAQ,KACV,CAAC,EACKY,EAAe,SAAY,CAE/B,IAAMH,GADO,MAAMC,EAAa,GACd,MAAMP,CAAK,EAC7B,OAAOM,GAAOA,EAAK,CAAC,GAAK,IAC3B,EACMI,EAAY,IAAM,CACtB,OAAO,iBAAiB,OAAQC,CAAY,EAC5C,SAAS,iBAAiB,mBAAoBC,CAAsB,CACtE,EAEMA,EAAyB,SAAY,CACzC,GAAI,SAAS,kBAAoB,UAAW,CAC1C,IAAMC,EAAO,MAAMJ,EAAa,EAC5BI,IAASX,EACXY,EAAc,GAAM,CAClB,SAAUD,EACV,YAAaX,CACf,CAAC,EAEDa,EAAU,OAGZ,cAAcd,CAAK,CAEvB,EACMU,EAAe,SAAY,CAC/B,IAAME,EAAO,MAAMJ,EAAa,EAC5BI,IAASX,GACXY,EAAc,GAAM,CAClB,SAAUD,EACV,YAAaX,CACf,CAAC,CAEL,EACMY,EAAgB,CAACE,EAAiBV,IAAe,CACrD,IAAMD,EAASD,EAAgBY,EAAQV,CAAI,EAC3C,OAAO,cAAcD,CAAM,EACtBF,IACHD,EAAcI,EAAK,SAEvB,EACMS,EAAY,IAAM,CACtBd,EAAQ,YAAY,SAAY,CAC9B,IAAMY,EAAO,MAAMJ,EAAa,EAC5BI,IAASX,GACXY,EAAc,GAAM,CAClB,SAAUD,EACV,YAAaX,CACf,CAAC,CAEL,EAAGL,EAAO,KAAK,CACjB,EACKK,IACLQ,EAAU,EACVK,EAAU,EACZ",
  "names": ["worker", "greenlet", "blob", "workerUrl", "workerInstance", "url", "init", "resolve", "reject", "e", "useGreenlet", "useNotification", "params", "getCurrentHash", "body", "regex", "timer", "currentHash", "loop", "useCreateNotify", "notice", "data", "queryNewHash", "useGreenlet", "validateHash", "initEvent", "windowLoaded", "handleVisibilityChange", "hash", "dispatchEvent", "initTimer", "status"]
}
